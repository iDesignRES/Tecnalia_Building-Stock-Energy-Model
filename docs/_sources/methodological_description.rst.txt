Methodological description
==========================

Mathematical description
~~~~~~~~~~~~~~~~~~~~~~~~
The most relevant aspects of the mathematical description of the model are detailed below. It should be noted that this model corresponds to the adaptation of a previous model, so that once the basic methodological basis has been described, detailed descriptions of previous studies will be redirected.

This section is composed of different subsections, each of them focused on the description of the most relevant methodological and mathematical aspects of each of the large blocks described in the model design philosophy section.

Pre-processing of basic data of the building stock
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

a) BUILDINGS
^^^^^^^^^^^^

Pre-processing of building-level information
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
This section describes the process followed for the preprocessing and treatment of the basic information of each building in the selected region. This is a process that the model executes without the need of inputs or user intervention. It is only necessary that the user selects the region to be evaluated.

The method is mainly based on the information available from OpenStreetMap [1]_. This provides relevant information for the selected region regarding the geometry of the buildings and their use. However, this information has many gaps that are being filled in with other public data sources. Information available from the EU Building Stock Observatory [2]_ is used (which is the main classification used by the country level ESM tools to which the new model will be linked), as well as information from sources such as the Global Human Settlement Layer (GSH) data [3]_ and the Hotmaps project [4]_. 

The method is integrated in a Python script capable of preparing the building stock energy data for any region of Europe. It provides relevant information per building of the region selected including the age, height, gross floor area, geometric shape and use and sub-use for residential and tertiary in a geolocated way.

Thus, when the user selects the NUTS Level 2 region to be evaluated, this process cuts the information corresponding to the geographical limits established for each of the information layers used. In a second phase, the information of each layer is processed to associate the characteristics to be extracted from it for one of the buildings contemplated in the region. This process can be replicated for an analysis to be performed at the NUTS level3 disaggregation level.

The performance of this development has been evaluated by comparing the results obtained with respect to the results obtained using a much more detailed and time-consuming approach which requires access to information based on cadastral data. This comparison has been carried out for the case of the city of Bilbao (a relevant city in the Basque Country, Spain), being aware that this is a very demanding comparative study as it evaluates the performance of the development for a city scale, which is more demanding than the regional scale. More details can be consulted in a paper dedicated to this section Data processing for georeferenced building characterization aimed at energy modelling of different NUTS level 2 regions of Europe [5]_.


Information processing for the generation of archetypes
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
In a next step building archetypes for each building typology according to their use and age are generated. In this way, through clustering methods, this process defines the number of building archetypes that are the most representative for each building typology (according to the use and age disaggregation). This simplifies the calculation of energy demands and consumption of the building stock regional energy model as buildings meeting certain characteristics can be grouped together to perform the energy calculation and not have to do it for each individual building. This is of greater interest as the scale of analysis is extended beyond the urban area.  

The generated information is processed to identify representative building archetypes, which serve as additional input data to the building stock model, and which will contribute to accelerate energy demand calculations in the following steps of the energy planning process. For this purpose, the KMeans clustering algorithm [6]_ has been applied for each of the branches of the disaggregated tree of the building sector. 

Once the clustering has been performed, the algorithm selects the building corresponding to the centroid of each cluster as the representative building to complete the final characterization of each archetype. 

In this case, the resulting clusters for building blocks in the residential sector by construction periods were obtained using specific parameters for grouping, such as the form factor, the ratio of the external façade area to the total façade area (including adjacent façades), and the building height. The building corresponding to the centroid of each cluster serves as the basis for defining the characteristics of the archetype used in the calculations.

b) SOLAR
^^^^^^^^
This section describes the information preprocessing process used as input to the solar building technology assessment module.

The process determines for each selected region which buildings are suitable for the potential implementation of solar technology. 

For each region a raster file is generated with the buildings of potential radiation differentiated by different radiation ranges or thresholds. This is intended to obtain more criteria to determine which are the most interesting areas in which to start deploying solar technology once the alternative scenarios are being generate.

As output of this process, the results obtained in terms of the region ID (NUTS Level 3 and NUTS Leve 2), the coordinates of the region centroid, the total area, the maximum radiation, the average radiation, and the area corresponding to each of the buildings corresponding to each radiation threshold measured above are stored.

This information is used in later phases to calculate solar generation, taking as inputs data with a high degree of disaggregation.

The different layers of information used in the process described above are listed in more detail below.
- Global solar radiation atlas GHI at 200x200m resolution [7]_.
- Land use map: 100x100m. Selected from this layer the uses corresponding to each building typology.

The following is a more detailed description of the preprocessing process according to its logic and processing sequence.

Data Preparation and Clipping
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
- Clip the NUTS (Nomenclature of Territorial Units for Statistics) regions layer to the selected NUTS 2 or NUTS 3 region.
- Clip the following layers to the selected region: (Land use, Solar radiation).

Land Use Layer Filtering
^^^^^^^^^^^^^^^^^^^^^^^^
The land use layer is filtered to identify specific land cover types suitable for solar installation:
- User-defined codes for suitable building types (e.g., Single family houses, Apartments, Health, Hotels, Offices, Sport, Trade) are used to filter the layer.
- Pixels corresponding to the specified land use codes are set to 1, while all others are set to 0.

Raster Alignment and Standardization
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
All layers are aligned and adjusted to ensure consistent resolution, projection system, and size across datasets.

Regional Analysis and Reporting
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
The code performs a regional analysis based on the potential radiation areas:
- Radiation thresholds are defined from a starting value to the maximum raster value, incrementing by 100.
- A Data Frame is created to store results, including region ID, centroid coordinates, total area, maximum radiation, average radiation, and area corresponding to each radiation threshold.
- The code iterates over each NUTS 3 region, calculating values for each radiation threshold.
- Results are saved as a CSV file in the same directory as the input raster file.

Region,Centroid_X,Centroid_Y,Total_Area,Max_Radiation,Average_Radiation,Threshold,Area_m2,Median_Radiation,Median_Radiation_X,Median_Radiation_Y

Calculation of energy needs and energy consumption of buildings in the region
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Buildings
^^^^^^^^^
The most relevant mathematical equations used for the calculation of the energy needs of buildings are described below. These algorithms are applicable to different building typologies, from residential buildings to tertiary buildings. 
It should be noted however that for each case, the input parameters considered in this building stock energy model are different depending on the use and age of the buildings::

	ACD_{k} = \sum_{i,j=1}^{8760} 
	\Big( 
	CDH_{i,j} \times A_{k} \times U_{k} 
	+ Gains_{i,j} 
	+ cventilation\ losses_{i,j} \times (1 - n_{HR}) 
	\Big) 
	\cdot cooling\ schedule_{i,j}

Where ACDk is the annual cooling useful energy demand (kWh/year), CDHi,j is the cooling degree hours (°C), Ak is the envelope element surface (m :sup:`2`), Uk is the thermal transmittance (W/(m :sup:`2`·K)), ηHR is the heat recovery system efficiency (%), i is the hour of the day and j is the day of the year.

Finally, the annual domestic hot water demand is determined by multiplying the annual DWH demand per square meter, the gross floor area of the building and the normalized usage factor of the DHW::

	DHWD_{k} = 
	\sum_{i,j=1}^{8760} 
	\left(
	DHW\ demand_{k} \times NHA_{k} \times 
	\frac{
	Hourly\ usage\ factor_{DHW,i,j}
	}{
	\sum_{i,j=1}^{8760} Hourly\ usage\ factor_{DHW,i,j}
	}
	\right)

Where DHWDk is the annual domestic hot water useful energy demand (kWh/year), DHWk is the domestic hot water demand (kWh/m :sup:`2`),  NHAk is the net heated area (m :sup:`2`), i is the hour of the day and j is the day of the year.
The values of the parameters used in the equations vary according to the location, age, or use of the building, as shown in the table 1.

**Table 1**. Dependence of the parameters according to the characteristics of the buildings:

+--------------+-----------+----------------+---------+--------------------+-------------+-------------+-----+
|              | Schedules | Internal gains | U-value | Ventilation losses | Solar gains | DHW demands | WWR |
+==============+===========+================+=========+====================+=============+=============+=====+
| **Location** |           |                |    X    |          X         |      X      |             |     |
+--------------+-----------+----------------+---------+--------------------+-------------+-------------+-----+
| **Age**      |           |                |    X    |          X         |             |             |     |
+--------------+-----------+----------------+---------+--------------------+-------------+-------------+-----+
| **Use**      |     X     |       X        |    X    |                    |      X      |      X      |  X  |
+--------------+-----------+----------------+---------+--------------------+-------------+-------------+-----+

Internal database
^^^^^^^^^^^^^^^^^
The building stock model incorporates a database with the most relevant information that is necessary for its implementation. It combines information downloaded from different sources such as Demand.ninja [8]_ for weather (hourly data), the EU Buildings Stock Observatory [9]_ for basic data such as thermal transmittances by building type, age, and location, or the European Commission, Joint Research Centre (JRC) Dataset [10]_ to obtain preliminary shares of technology use by final energy use for each building typology and energy performances of technologies for energy consumption calculation.

**Table 2**. Structure of technology use by final energy use for each building typology used to define the share of technologies as preliminary data of the model per country:

+----------------------------------------+-----------------+------------------------------------------------------------+
| Category / Subcategory                 | Value (kWh/sqm) | Code                                                       |
+========================================+=================+============================================================+
| **Final energy consumption (kWh/sqm)** | 61.2            | FEC_per_sqm.kWh.ES.Res.HH.Thermal                          |
+----------------------------------------+-----------------+------------------------------------------------------------+
| **Space heating**                      | 41.6            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SH                       |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Solids                                 | 41.0            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SH.Solids.Solids         |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Liquefied petroleum gas (LPG)          | 47.7            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SH.LPG.LPG               |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Diesel oil                             | 47.1            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SH.Oil.Oil_LiqBio        |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Natural gas                            | 41.9            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SH.Gas.NG_Biogas         |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Biomass                                | 45.5            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SH.Biomass.Biomass_Waste |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Geothermal                             | 36.8            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SH.Geo.Geo               |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Distributed heat                       | \-              | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SH.DistrHeat.Steam_Distr |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Advanced electric heating              | 9.1             | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SH.AdvElec.Elec          |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Conventional electric heating          | 35.2            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SH.ConvElec.Elec         |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Electricity in circulation             | 0.4             | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SH.TotalCirculation.Elec |
+----------------------------------------+-----------------+------------------------------------------------------------+
| **Space cooling**                      | 0.9             | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SC                       |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Air conditioning                       | 0.9             | FEC_per_sqm.kWh.ES.Res.HH.Thermal.SC.AC.Elec               |
+----------------------------------------+-----------------+------------------------------------------------------------+
| **Water heating**                      | 12.2            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.WH                       |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Solids                                 | 12.0            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.WH.Solids.Solids         |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Liquefied petroleum gas (LPG)          | 12.3            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.WH.LPG.LPG               |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Diesel oil                             | 13.8            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.WH.Oil.Oil_LiqBio        |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Natural gas                            | 13.2            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.WH.Gas.NG_Biogas         |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Biomass                                | 12.2            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.WH.Biomass.Biomass_Waste |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Geothermal                             | 11.3            | FEC_per_sqm.kWh.ES.Res.HH.Thermal.WH.Geo.Geo               |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Distributed heat                       | \-              | FEC_per_sqm.kWh.ES.Res.HH.Thermal.WH.DistrHeat.Steam_Distr |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Electricity                            | 6.9             | FEC_per_sqm.kWh.ES.Res.HH.Thermal.WH.Elec.Elec             |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Solar                                  | 8.5             | FEC_per_sqm.kWh.ES.Res.HH.Thermal.WH.TotalSolar.Solar      |
+----------------------------------------+-----------------+------------------------------------------------------------+
| **Cooking**                            | 6.6             | FEC_per_sqm.kWh.ES.Res.HH.Thermal.CO                       |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Solids                                 | 7.4             | FEC_per_sqm.kWh.ES.Res.HH.Thermal.CO.Solids.Solids         |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Liquefied petroleum gas (LPG)          | 8.0             | FEC_per_sqm.kWh.ES.Res.HH.Thermal.CO.LPG.LPG               |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Natural gas                            | 8.1             | FEC_per_sqm.kWh.ES.Res.HH.Thermal.CO.Gas.NG_Biogas         |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Biomass                                | 8.1             | FEC_per_sqm.kWh.ES.Res.HH.Thermal.CO.Biomass.Biomass_Waste |
+----------------------------------------+-----------------+------------------------------------------------------------+
| Electricity                            | 5.6             | FEC_per_sqm.kWh.ES.Res.HH.Thermal.CO.Elec.Elec             |
+----------------------------------------+-----------------+------------------------------------------------------------+

It should be noted that all these parameters together with the use profiles of each building typology are susceptible to being substituted by more precise input data that the modeler may have available for the region being evaluated. As a conceptual example, the simplified form of data entry for each building typology is shown for each building typology in terms of weekday consumption profiles by final energy use.

**Table 3**. Weekday consumption profiles by final energy use:

+---------+---------+---------+----------+-----------+-----------+-----+---------+
| Weekday | Heating | Cooling | Lighting | Equipment | Occupancy | DHW | Cooking |
+=========+=========+=========+==========+===========+===========+=====+=========+
| 0:00    | 0.0     | 0.2     | 0.3      | 0.3       | 1.0       | 0.3 | 0.0     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 1:00    | 0.0     | 0.1     | 0.3      | 0.3       | 1.0       | 0.1 | 0.0     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 2:00    | 0.0     | 0.1     | 0.3      | 0.3       | 1.0       | 0.1 | 0.0     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 3:00    | 0.1     | 0.1     | 0.3      | 0.3       | 1.0       | 0.1 | 0.0     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 4:00    | 0.1     | 0.2     | 0.5      | 0.5       | 1.0       | 0.1 | 0.0     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 5:00    | 0.1     | 0.6     | 0.9      | 0.9       | 1.0       | 0.1 | 0.0     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 6:00    | 0.9     | 0.9     | 0.9      | 1.0       | 1.0       | 0.5 | 0.5     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 7:00    | 1.0     | 1.0     | 0.9      | 1.0       | 0.5       | 0.5 | 0.5     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 8:00    | 0.9     | 0.9     | 0.8      | 0.9       | 0.3       | 0.3 | 0.3     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 9:00    | 0.5     | 0.7     | 0.8      | 0.8       | 0.3       | 0.3 | 0.3     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 10:00   | 0.6     | 0.4     | 0.9      | 0.9       | 0.3       | 0.3 | 0.1     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 11:00   | 0.7     | 0.2     | 0.9      | 0.9       | 0.3       | 0.3 | 0.1     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 12:00   | 0.6     | 0.2     | 0.3      | 0.3       | 0.3       | 0.3 | 0.9     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 13:00   | 0.7     | 0.1     | 0.3      | 0.3       | 0.3       | 0.3 | 0.9     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 14:00   | 0.7     | 0.2     | 0.5      | 0.5       | 0.5       | 0.5 | 0.6     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 15:00   | 0.7     | 0.2     | 0.5      | 0.5       | 0.5       | 0.5 | 0.6     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 16:00   | 0.7     | 0.2     | 0.5      | 0.5       | 0.5       | 0.5 | 0.6     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 17:00   | 0.7     | 0.5     | 0.8      | 0.8       | 0.5       | 0.5 | 0.6     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 18:00   | 0.8     | 0.9     | 0.9      | 0.9       | 0.5       | 0.5 | 0.6     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 19:00   | 0.9     | 0.9     | 0.8      | 0.8       | 0.5       | 0.5 | 0.8     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 20:00   | 0.9     | 0.7     | 0.6      | 0.6       | 0.5       | 0.5 | 0.8     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 21:00   | 0.9     | 0.7     | 0.6      | 0.6       | 0.5       | 0.5 | 0.8     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 22:00   | 0.7     | 0.4     | 0.9      | 0.9       | 0.5       | 0.5 | 0.6     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+
| 23:00   | 0.5     | 0.2     | 0.7      | 0.7       | 1.0       | 1.0 | 0.3     |
+---------+---------+---------+----------+-----------+-----------+-----+---------+

Building integrated solar systems
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Once potential areas of each building type in each NUTS3 region are categorized by intervals of 100W/m :sup:`2` of Global Horizontal Irradiance (GHI), those with higher GHI are selected until reaching the area, power capacity or investment required by the user at the input.

The required power capacity is calculated from the investment considering the following unit costs. These can be also configured by the user.

**Table 4**. Unit cost in €/Wp for each building typology:

+-------------+---------------------+------------------+
| Category    | Subcategory         | Unit cost (€/Wp) |
+=============+=====================+==================+
| Residential | Single-family house | 1.2              |
+-------------+---------------------+------------------+
|             | Apartment           | 0.8              |
+-------------+---------------------+------------------+
| Commercial  | Health              | 0.8              |
+-------------+---------------------+------------------+
|             | Hotels              | 0.8              |
+-------------+---------------------+------------------+
|             | Offices             | 0.8              |
+-------------+---------------------+------------------+
|             | Sports              | 0.8              |
+-------------+---------------------+------------------+
|             | Trade               | 0.8              |
+-------------+---------------------+------------------+

The required area is calculated from the power capacity considering the following system efficiencies and use factors, understood as the rate of area in the building to install PV. These can be also configured by the user.

**Table 5.** System efficiency and use factor in % for each building typology:

+-------------+---------------------+-----------------------+----------------+
| Category    | Subcategory         | System efficiency (%) | Use factor (%) |
+=============+=====================+=======================+================+
| Residential | Single-family house | 25                    | 60             |
+-------------+---------------------+-----------------------+----------------+
|             | Apartment           | 15                    | 80             |
+-------------+---------------------+-----------------------+----------------+
| Commercial  | Health              | 15                    | 80             |
+-------------+---------------------+-----------------------+----------------+
|             | Hotels              | 15                    | 80             |
+-------------+---------------------+-----------------------+----------------+
|             | Offices             | 15                    | 80             |
+-------------+---------------------+-----------------------+----------------+
|             | Sports              | 15                    | 80             |
+-------------+---------------------+-----------------------+----------------+
|             | Trade               | 15                    | 80             |
+-------------+---------------------+-----------------------+----------------+

For the location corresponding to the median of GHI of each selected area of each NUTS3 the Photovoltaic (PV) generation profile is estimated and then aggregated for all the selected areas of all the NUTS3 to compute the PV generation profile in buildings for the whole NUTS2 region.     

The tool used to estimate the Photovoltaic generation in buildings is PVGIS [11]_, a free web application that allows the user to get data on solar radiation and photovoltaic system energy production. This is automatedly accessible via API.

First of all, PVGIS makes use of reanalysis-based solar radiation data sets to estimate the solar radiation arriving at the earth surface. Data. Reanalysis data are calculated using numerical weather forecast models, re-running the models for the past and making corrections using the known meteorological measurements. The output of the models is a large number of meteorological quantities, often including the solar irradiance at ground level.  More concretely, ECMWF ERA-5, produced by the European Centre for Medium-range Weather Forecast (ECMWF), has global coverage at a resolution of about 30km, and includes both global and direct solar irradiance. At the time of writing, only the time period 2005-2020 has been in PVGIS along with global coverage. 

The satellite-based calculation described above produces values of global and beam irradiance on a horizontal plane. However, modules and PV systems are generally installed at an inclined angle regarding the horizontal plane or on tracking systems, so as to maximize the received in-plane irradiance. Therefore, the satellite retrieved irradiance values are not representative of the solar radiation available at the module surface, and it becomes necessary to estimate the in-plane irradiance.

There are several models in the scientific bibliography which use as input data the irradiance values on the horizontal plane of global and diffuse and/or beam irradiance components, to estimate the values of the beam and diffuse components on tilted surfaces. A comparison of some of these models can be found in *Gracia Amillo and Huld, 2013*. The estimation model implemented in PVGIS is the one developed by Muneer T. (1990) , which can be classified as anisotropic of two components.

In the case of buildings, fixed mounting structure has been considered with optimal azimuth (South oriented) and a tilt of 20º as a trade-off between energy yield and system efficiency. Only in the case of single-family houses 20% of the systems are East-oriented and other 20% West-oriented, as these are normally adapted to roof orientation. 

On the other hand, PVGIS uses information about the elevation of the terrain with a resolution of 3 arc-seconds (about 90m). This means that for every 90m we have a value for the ground elevation. From these data we have calculated the height of the horizon around each geographical location. These data are then used to calculate the times when the sun is shadowed by hills or mountains. When this happens, the solar radiation is then calculated using only the diffuse part of the radiation. Please notice that with a resolution of ~90m the calculations in PVGIS cannot consider the effects of shadows from nearby objects such as houses or trees. Therefore, a higher “system loss” than usual must be considered for PV in buildings.

Indeed, once the amount of solar radiation that arrives at the PV modules is computed, the different effects that influence PV output and how they are calculated in PVGIS.

- Shallow-angle reflection. This is calculated using a mathematical model described in *(Martin&Ruiz, 2001, Martin&Ruiz, 2013)*. Generally, this effect causes a loss of 2-4% of the sunlight, though this will be lower for sun-tracking PV systems *(Huld et al., 2015)*.
- Effects of changes in the solar spectrum. PVGIS has used solar radiation data from satellite that have been calculated for different spectral bands *(Mueller et al., 2012)* to calculate the effect of spectrum changes on the PV energy output.
- PV power dependence on irradiance and module temperature. PVGIS calculates the effects of irradiance and module temperature using a model described in *(Huld et al., 2011)*. Module temperature is treated in PVGIS using a model suggested by Faiman (*Faiman, 2008*) and the BIPV/BAPV configuration is selected in this case.
- System losses and degradation. Considering the system losses and the losses due to ageing PVGIS recommends a value of 14% for the "system loss" that the user gives as input to PVGIS. However, there are a number of other effects that can influence the energy output of PV systems. These effects are not included in the PVGIS calculations. Among these are: snow, soling, partial shadowing. Considering building environment, more prone to the appearance of these issues, a value of 20% is set for the “system loss” in this case.

Energy scenario configuration
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
For the configuration of future scenarios, the model allows a simulation of a given fixed year, allowing to configure the main characteristics of that year. 

In the buildings sector, the model allows to consider the effect of the evolution of HDD and CDD in the future, as well as the construction of new buildings. Based on this configuration, the model makes it possible to determine the degree of deployment of different technologies or measures applicable to each typology and archetype of buildings defined.

For example, in the case of building retrofitting, the logic behind the configuration of retrofitting scenarios for each building typology is explained. Depending on the selected degree of retrofitting, the model adjusts the thermal transmittance values of the building envelope to recalculate the new energy consumption.

**Table 6**. Logic behind the configuration of retrofitting scenarios for each building typology:

+---------------------------------+------------+----------+-----------+-----------+-----------+-----------+-----------+-----------+
| Category                        | Ref. level | Pre-1945 | 1945-1969 | 1970-1979 | 1980-1989 | 1990-1999 | 2000-2010 | Post-2010 |
+=================================+============+==========+===========+===========+===========+===========+===========+===========+
| Apartment block                 | Low        | 85%      | 25%       | 13%       | 0%        | 0%        | 0%        | 0%        |
+---------------------------------+------------+----------+-----------+-----------+-----------+-----------+-----------+-----------+
| Single family - Terraced houses | High       | 50%      | 17%       | 0%        | 0%        | 0%        | 0%        | 0%        |
+---------------------------------+------------+----------+-----------+-----------+-----------+-----------+-----------+-----------+
| Offices                         | Medium     | 5%       | 5%        | 5%        | 5%        | 5%        | 0%        | 0%        |
+---------------------------------+------------+----------+-----------+-----------+-----------+-----------+-----------+-----------+
| Education                       | Medium     | 10%      | 10%       | 10%       | 10%       | 10%       | 10%       | 10%       |
+---------------------------------+------------+----------+-----------+-----------+-----------+-----------+-----------+-----------+
| Health                          | Low        | 0%       | 0%        | 0%        | 0%        | 0%        | 0%        | 0%        |
+---------------------------------+------------+----------+-----------+-----------+-----------+-----------+-----------+-----------+
| Trade                           | Low        | 0%       | 0%        | 0%        | 0%        | 0%        | 0%        | 0%        |
+---------------------------------+------------+----------+-----------+-----------+-----------+-----------+-----------+-----------+
| Hotels and Restaurants          | Medium     | 0%       | 0%        | 0%        | 0%        | 0%        | 0%        | 0%        |
+---------------------------------+------------+----------+-----------+-----------+-----------+-----------+-----------+-----------+
| Other non-residential buildings | Medium     | 0%       | 0%        | 0%        | 0%        | 0%        | 0%        | 0%        |
+---------------------------------+------------+----------+-----------+-----------+-----------+-----------+-----------+-----------+
| Sport                           | Medium     | 0%       | 0%        | 0%        | 0%        | 0%        | 0%        | 0%        |
+---------------------------------+------------+----------+-----------+-----------+-----------+-----------+-----------+-----------+

**Input parameters**

- Definition of building types::

	BUILDING_TYPES = [
		'Apartment block',
		'Single family- Terraced houses',
		'Offices',
		'Education',
		'Health',
		'Trade',
		'Hotels and Restaurants',
		'Other non-residential buildings',
		'Sport'
	]

- Construction periods::

	CONSTRUCTION_PERIODS = [
		'Pre-1945',
		'1945-1969',
		'1970-1979',
		'1980-1989',
		'1990-1999',
		'2000-2010',
		'Post-2010'
	]

- Reference levels for building refurbishment::

	REFERENCE_LEVELS = {
		'Low',
		'Medium'
		'High'
	}

- Percentage of surface area to be refurbished by building type and construction period::

	RENOVATION_PERCENTAGE = {
		'Apartment block': {
			'Pre-1945': 100,
			'1945-1969': 0,
			'1970-1979': 0,
			'1980-1989': 0,
			'1990-1999': 0,
			'2000-2010': 0,
			'Post-2010': 0
		},
		'Single family- Terraced houses': {
			'Pre-1945': 0,
			'1945-1969': 0,
			'1970-1979': 0,
			'1980-1989': 0,
			'1990-1999': 0,
			'2000-2010': 0,
			'Post-2010': 0
		},
		 ... (repeated for other building types)
	}

Similarly, the configuration of technology substitution scenarios can be configured for each building typology according to the logic shown in the following table. 

Thus, the described % is associated with a given built-up area, a given number of buildings, a given number of technologies replaced (number or installed capacity) and a given investment.

**Table 7**. New technology share configuration by end use for a typical building:

+---------------------------------------------+------------------------+------------------------+
| Energy service                              | Baseline configuration | Scenario configuration |
+=============================================+========================+========================+
| **Space heating**                           | 100,00%                | 100,00%                |
+---------------------------------------------+------------------------+------------------------+
| Space heating_Solids                        | 0,18%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space heating_LPG                           | 0,45%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space heating_Diesel oil                    | 12,62%                 | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space heating_Gas heat pumps                | 0,00%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space heating_Natural gas                   | 23,53%                 | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space heating_Biomass                       | 30,95%                 | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space heating_Geothermal                    | 0,00%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space heating_Distributed heat              | 14,66%                 | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space heating_Advanced electric heating     | 9,27%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space heating_Conventional electric heating | 7,32%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space heating_BioOil                        | 0,00%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space heating_BioGas                        | 0,00%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space heating_Hydrogen                      | 0,00%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| **Electricity in circulation**              | 1,03%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| **Space cooling**                           | 7,80%                  | 7,80%                  |
+---------------------------------------------+------------------------+------------------------+
| Space cooling_Gas heat pumps                | 0,00%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Space cooling_Electric space cooling        | 100,00%                | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| **Water heating**                           | 100,00%                | 100,00%                |
+---------------------------------------------+------------------------+------------------------+
| Water heating_Solids                        | 0,05%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Water heating_LPG                           | 0,31%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Water heating_Diesel oil                    | 8,19%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Water heating_Natural gas                   | 17,64%                 | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Water heating_Biomass                       | 17,69%                 | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Water heating_Geothermal                    | 0,00%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Water heating_Distributed heat              | 14,00%                 | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Water heating_Electricity                   | 28,40%                 | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Water heating_BioOil                        | 0,00%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Water heating_BioGas                        | 0,00%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Water heating_Hydrogen                      | 0,00%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| **Water heating_Solar**                     | 13,72%                 | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| **Cooking**                                 | 100,00%                | 100,00%                |
+---------------------------------------------+------------------------+------------------------+
| Cooking_Solids                              | 0,02%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Cooking_LPG                                 | 0,19%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Cooking_Natural gas                         | 4,06%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Cooking_Biomass                             | 2,85%                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| Cooking_Electricity                         | 92,89%                 | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| **Appliances**                              | 100,00%                | 100,00%                |
+---------------------------------------------+------------------------+------------------------+
| Appliances_Electricity                      | 1,000                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+
| **Lighting**                                | 100,00%                | 100,00%                |
+---------------------------------------------+------------------------+------------------------+
| Lighting_Electricity                        | 1,000                  | Insert                 |
+---------------------------------------------+------------------------+------------------------+

References
~~~~~~~~~~
.. [1] "OpenStreetMap data. https://download.geofabrik.de/europe.html (accessed Jun. 11, 2024).

.. [2] European Union, "EU Building Stock Observatory database." [Online]. Available: https://energy.ec.europa.eu/topics/energy-efficiency/energy-efficient-buildings/eu-building-stock-observatory_en.

.. [3] "GHSL - Global Human Settlement Layer." https://human-settlement.emergency.copernicus.eu/download.php (accessed Jun. 11, 2024)

.. [4] "Hotmaps project." https://www.hotmaps.eu/map (accessed Jun. 11, 2024).

.. [5] E. Arrizabalaga1, N. Hermoso1, J. Pedrero1, I. Muñoz1, L. Mabe1 .(2024) Data processing for georeferenced building characterization aimed at energy modelling of different NUTS level 2 regions of Europe. European Climate and Energy Modelling Platform 2024 (ECEMP) Brussels and online 16th to 17th October 2024.

.. [6] https://scikit-learn.org/1.5/modules/clustering.html#k-means

.. [7] https://globalsolaratlas.info/download/world

.. [8] https://renewables.ninja/

.. [9] European Commission. EU Buildings Stock Observatory. Available: http://ec.europa.eu/energy/en/eubuildings    

.. [10] Rozsai, Mate; Jaxa-Rozen, Marc; Salvucci, Raffaele; Sikora, Przemyslaw; Tattini, Jacopo; Neuwahl, Frederik (2024): JRC-IDEES-2021. European Commission, Joint Research Centre (JRC) [Dataset] PID: http://data.europa.eu/89h/82322924-506a-4c9a-8532-2bdd30d69bf5  

.. [11] PVGIS data sources & calculation methods - European Commission